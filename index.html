<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UXMAL Pro - Sistema de Incidencias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-solucionado { background: #d1fae5; color: #065f46; }
        .status-cerrado { background: #e0e7ff; color: #3730a3; }
        .status-seguimiento { background: #fef3c7; color: #92400e; }
        .status-atencion { background: #fee2e2; color: #991b1b; }
        .status-pendiente { background: #f3f4f6; color: #374151; }
        
        .role-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .role-admin { background: #dbeafe; color: #1e40af; }
        .role-colaborador { background: #e0e7ff; color: #3730a3; }
        .role-cliente { background: #fef3c7; color: #92400e; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; margin: 30px auto; max-width: 1000px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideIn 0.3s ease; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; transform: translateX(400px); transition: transform 0.3s ease; z-index: 2000; display: flex; align-items: center; gap: 8px; }
        .toast.show { transform: translateX(0); }
        
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); max-width: 400px; width: 90%; text-align: center; }
        
        .hidden { display: none !important; }
        
        .nav-item.active { background: #2563eb; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <!-- CONFIGURACIÓN DE SUPABASE -->
    <script>
        const SUPABASE_URL = 'https://evlenjpwgyxmdduvlyot.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bGVuanB3Z3l4bWRkdXZseW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExODMyMTIsImV4cCI6MjA4Njc1OTIxMn0.hZBQonAB69fS4iOW_LFb-hpZrwR-BOFoOfOE-2rVqrQ';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center font-bold text-2xl text-white mx-auto mb-4">UX</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Bienvenido a UXMAL Pro</h2>
            <p class="text-slate-500 mb-6">Ingresa tus credenciales</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="tu@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="••••••••">
                </div>
            </div>
            
            <button onclick="login()" id="loginBtn" class="w-full mt-6 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-all">
                Ingresar al Sistema
            </button>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="flex h-screen overflow-hidden hidden">
        <aside class="w-64 bg-slate-900 text-white flex flex-col">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center font-bold text-lg">UX</div>
                    <div>
                        <h1 class="font-bold text-lg">UXMAL Pro</h1>
                        <p class="text-xs text-slate-400" id="userDisplay">Usuario</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1">
                <a href="#" onclick="showTab('dashboard')" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg text-white font-medium transition-colors">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </a>
                <a href="#" onclick="showTab('tickets')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-clipboard-list w-5"></i> Incidencias
                </a>
                <a href="#" onclick="showTab('clientes')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-database w-5"></i> Clientes
                </a>
                <a href="#" id="nav-usuarios" onclick="showTab('usuarios')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors hidden">
                    <i class="fas fa-users-cog w-5"></i> Usuarios
                </a>
            </nav>
            
            <div class="p-4 border-t border-slate-700">
                <button onclick="logout()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2 transition-all text-sm">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </aside>
        
        <main class="flex-1 overflow-y-auto p-8">
            <!-- Dashboard -->
            <div id="tab-dashboard" class="tab-content">
                <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                        <p class="text-xs font-medium text-slate-500 uppercase">Total Tickets</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="dash-total">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm border-l-4 border-red-500">
                        <p class="text-xs font-medium text-slate-500 uppercase">En Atención</p>
                        <p class="text-3xl font-bold text-red-600 mt-2" id="dash-atencion">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm border-l-4 border-emerald-500">
                        <p class="text-xs font-medium text-slate-500 uppercase">Solucionados</p>
                        <p class="text-3xl font-bold text-emerald-600 mt-2" id="dash-solucionados">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm border-l-4 border-amber-500">
                        <p class="text-xs font-medium text-slate-500 uppercase">Pendientes</p>
                        <p class="text-3xl font-bold text-amber-600 mt-2" id="dash-pendientes">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Tickets -->
            <div id="tab-tickets" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Incidencias</h2>
                    <button onclick="openModal('newTicket')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-plus"></i> Nueva Incidencia
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Folio</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Falla</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Clientes -->
            <div id="tab-clientes" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">Clientes</h2>
                <div id="clientes-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
            
            <!-- Usuarios (Admin Only) -->
            <div id="tab-usuarios" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Gestión de Usuarios</h2>
                    <button onclick="openModal('newUser')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-user-plus"></i> Nuevo Usuario
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Usuario</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Rol</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nueva Incidencia -->
    <div id="newTicketModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-slate-800">Nueva Incidencia</h3>
                <button onclick="closeModal('newTicket')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="ticketForm" onsubmit="saveTicket(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Folio</label>
                        <input type="text" id="input-folio" readonly class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Fecha</label>
                        <input type="date" id="input-fecha" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Cliente</label>
                    <select id="select-cliente" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="">Seleccionar cliente...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Falla</label>
                    <select id="select-falla" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="">Seleccionar falla...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Estatus</label>
                    <select id="select-estatus" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="EN ATENCIÓN TÉCNICA">En Atención Técnica</option>
                        <option value="SOLUCIONADO POR SOPORTE">Solucionado</option>
                        <option value="PENDIENTE POR CLIENTE">Pendiente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Comentarios</label>
                    <textarea id="input-comentarios" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('newTicket')" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo Usuario -->
    <div id="newUserModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-slate-800">Crear Nuevo Usuario</h3>
                <button onclick="closeModal('newUser')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo</label>
                    <input type="text" id="user-fullname" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Nombre del usuario">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="user-email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="usuario@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña</label>
                    <input type="password" id="user-password" required minlength="6" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Mínimo 6 caracteres">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Rol</label>
                        <select id="user-role" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            <option value="colaborador">Colaborador</option>
                            <option value="cliente">Cliente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div id="cliente-asignado-container" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Cliente Asignado</label>
                        <select id="user-cliente" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Teléfono (opcional)</label>
                    <input type="tel" id="user-telefono" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="555-123-4567">
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('newUser')" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">Cancelar</button>
                    <button type="submit" id="btn-save-user" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">Crear Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // VARIABLES GLOBALES
        let currentUser = null;
        let currentProfile = null;
        let tickets = [];
        let clientes = [];
        let catalogos = [];
        let allUsers = [];

        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', async function() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadUserProfile(session.user);
            } else {
                showLoginScreen();
            }
            
            // Escuchar cambios en rol para mostrar/ocultar selector de cliente
            document.getElementById('user-role')?.addEventListener('change', function() {
                const container = document.getElementById('cliente-asignado-container');
                if (this.value === 'cliente') {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });
        });

        // AUTENTICACIÓN
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Ingresa email y contraseña');
                return;
            }
            
            const btn = document.getElementById('loginBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                await loadUserProfile(data.user);
            } catch (error) {
                showError('Email o contraseña incorrectos');
                btn.innerHTML = 'Ingresar al Sistema';
                btn.disabled = false;
            }
        }

        async function loadUserProfile(user) {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) throw error;
                
                currentUser = user;
                currentProfile = profile;
                
                document.getElementById('userDisplay').textContent = profile.full_name;
                
                // Mostrar menú de usuarios solo si es admin
                if (profile.role === 'admin') {
                    document.getElementById('nav-usuarios').classList.remove('hidden');
                }
                
                showMainApp();
                await loadData();
                
            } catch (error) {
                console.error('Error:', error);
                showError('Error al cargar perfil');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentProfile = null;
            showLoginScreen();
        }

        // CARGA DE DATOS
        async function loadData() {
            // Cargar clientes
            const { data: clientesData } = await supabase.from('clientes').select('*').eq('activo', true);
            clientes = clientesData || [];
            
            // Cargar catálogos (fallas)
            const { data: catalogosData } = await supabase.from('catalogos').select('*').eq('tipo', 'falla');
            catalogos = catalogosData || [];
            
            // Cargar tickets según rol
            let query = supabase.from('tickets').select('*');
            if (currentProfile.role === 'colaborador') {
                query = query.or(`colaborador.eq.${currentProfile.full_name},asignado_a.eq.${currentProfile.full_name}`);
            } else if (currentProfile.role === 'cliente') {
                const cliente = clientes.find(c => c.id === currentProfile.cliente_asignado);
                if (cliente) {
                    query = query.eq('cliente', cliente.nombre);
                }
            }
            const { data: ticketsData } = await query.order('created_at', { ascending: false });
            tickets = ticketsData || [];
            
            // Si es admin, cargar usuarios
            if (currentProfile.role === 'admin') {
                await loadUsers();
            }
            
            renderDashboard();
            renderTickets();
            renderClientes();
            populateSelects();
        }

        async function loadUsers() {
            try {
                // Llamar a la Edge Function para listar usuarios
                const { data: { session } } = await supabase.auth.getSession();
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'list' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    allUsers = result.data.users || [];
                    renderUsers();
                } else {
                    console.error('Error cargando usuarios:', result.error);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // RENDERIZADO
        function renderDashboard() {
            document.getElementById('dash-total').textContent = tickets.length;
            document.getElementById('dash-atencion').textContent = tickets.filter(t => t.estatus === 'EN ATENCIÓN TÉCNICA').length;
            document.getElementById('dash-solucionados').textContent = tickets.filter(t => t.estatus === 'SOLUCIONADO POR SOPORTE').length;
            document.getElementById('dash-pendientes').textContent = tickets.filter(t => t.estatus === 'PENDIENTE POR CLIENTE').length;
        }

        function renderTickets() {
            const tbody = document.getElementById('tickets-table-body');
            tbody.innerHTML = tickets.map(t => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 font-bold text-slate-700">${t.folio}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${t.cliente}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${t.falla}</td>
                    <td class="px-4 py-3"><span class="status-badge ${getStatusClass(t.estatus)}">${t.estatus}</span></td>
                    <td class="px-4 py-3 text-sm text-slate-500">${t.fecha}</td>
                </tr>
            `).join('');
        }

        function renderClientes() {
            const container = document.getElementById('clientes-grid');
            container.innerHTML = clientes.map(c => `
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <h4 class="font-bold text-slate-800">${c.nombre}</h4>
                    <p class="text-sm text-slate-500 mt-1">Tickets: ${tickets.filter(t => t.cliente === c.nombre).length}</p>
                </div>
            `).join('');
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = allUsers.map(u => {
                const role = u.profile?.role || u.user_metadata?.rol || 'colaborador';
                return `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3">
                        <div class="font-medium text-slate-800">${u.profile?.full_name || u.user_metadata?.nombre || 'Sin nombre'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-slate-600">${u.email}</td>
                    <td class="px-4 py-3"><span class="role-badge role-${role}">${role}</span></td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${u.email_confirmed_at ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
                            ${u.email_confirmed_at ? 'Activo' : 'Pendiente'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        ${u.id !== currentUser.id ? `
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-800 transition-colors" title="Eliminar usuario">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        ` : '<span class="text-slate-400 text-xs">Tú</span>'}
                    </td>
                </tr>
            `}).join('');
        }

        function populateSelects() {
            const clienteSelect = document.getElementById('select-cliente');
            clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                clientes.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join('');
            
            const fallaSelect = document.getElementById('select-falla');
            fallaSelect.innerHTML = '<option value="">Seleccionar falla...</option>' +
                catalogos.map(f => `<option value="${f.valor}">${f.valor}</option>`).join('');
                
            // Poblar selector de clientes para usuarios
            const userClienteSelect = document.getElementById('user-cliente');
            if (userClienteSelect) {
                userClienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                    clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            }
        }

        // GUARDAR TICKET
        async function saveTicket(event) {
            event.preventDefault();
            
            const ticket = {
                folio: document.getElementById('input-folio').value,
                fecha: document.getElementById('input-fecha').value,
                hora: new Date().toTimeString().slice(0, 5),
                colaborador: currentProfile.full_name,
                asignado_a: currentProfile.full_name,
                cliente: document.getElementById('select-cliente').value,
                falla: document.getElementById('select-falla').value,
                estatus: document.getElementById('select-estatus').value,
                comentarios: document.getElementById('input-comentarios').value,
                metodo: 'Web',
                responsable: 'Uxmal'
            };
            
            try {
                const { error } = await supabase.from('tickets').insert([ticket]);
                if (error) throw error;
                
                showToast('Incidencia guardada', 'success');
                closeModal('newTicket');
                await loadData();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error al guardar', 'error');
            }
        }

        // GUARDAR USUARIO (ADMIN)
        async function saveUser(event) {
            event.preventDefault();
            
            const btn = document.getElementById('btn-save-user');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            btn.disabled = true;
            
            const userData = {
                full_name: document.getElementById('user-fullname').value,
                email: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                cliente_asignado: document.getElementById('user-cliente').value || null,
                telefono: document.getElementById('user-telefono').value || null
            };
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        action: 'create',
                        userData: userData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Usuario creado exitosamente', 'success');
                    closeModal('newUser');
                    document.getElementById('userForm').reset();
                    await loadUsers();
                } else {
                    throw new Error(result.error || 'Error al crear usuario');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Error al crear usuario', 'error');
            } finally {
                btn.innerHTML = 'Crear Usuario';
                btn.disabled = false;
            }
        }

        // ELIMINAR USUARIO
        async function deleteUser(userId) {
            if (!confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        action: 'delete',
                        userId: userId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Usuario eliminado', 'success');
                    await loadUsers();
                } else {
                    throw new Error(result.error || 'Error al eliminar');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Error al eliminar usuario', 'error');
            }
        }

        // UTILIDADES
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('input-fecha').valueAsDate = new Date();
            document.getElementById('input-folio').value = 'UX' + Date.now().toString().slice(-5);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active', 'bg-blue-600', 'text-white');
                n.classList.add('text-slate-300');
            });
            event.target.closest('.nav-item').classList.add('active', 'bg-blue-600', 'text-white');
            event.target.closest('.nav-item').classList.remove('text-slate-300');
        }

        function openModal(modal) {
            document.getElementById(modal + 'Modal').classList.add('active');
        }

        function closeModal(modal) {
            document.getElementById(modal + 'Modal').classList.remove('active');
        }

        function getStatusClass(status) {
            const classes = {
                'SOLUCIONADO POR SOPORTE': 'status-solucionado',
                'EN ATENCIÓN TÉCNICA': 'status-atencion',
                'PENDIENTE POR CLIENTE': 'status-pendiente',
                'EN SEGUIMIENTO': 'status-seguimiento',
                'CERRADO': 'status-cerrado'
            };
            return classes[status] || 'status-pendiente';
        }

        function showError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function showToast(message, type) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'bg-emerald-500' : 'bg-red-500'}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => toast.remove(), 3000);
        }

        // Exponer funciones globales
        window.login = login;
        window.logout = logout;
        window.showTab = showTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveTicket = saveTicket;
        window.saveUser = saveUser;
        window.deleteUser = deleteUser;
    </script>
</body>
</html>
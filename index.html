<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UXMAL Pro - Sistema de Incidencias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-solucionado { background: #d1fae5; color: #065f46; }
        .status-cerrado { background: #e0e7ff; color: #3730a3; }
        .status-seguimiento { background: #fef3c7; color: #92400e; }
        .status-atencion { background: #fee2e2; color: #991b1b; }
        .status-pendiente { background: #f3f4f6; color: #374151; }
        
        .role-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .role-admin { background: #dbeafe; color: #1e40af; }
        .role-colaborador { background: #e0e7ff; color: #3730a3; }
        .role-cliente { background: #fef3c7; color: #92400e; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; }
        .modal.active { display: block; }
        .modal-content { background: white; margin: 30px auto; max-width: 1000px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: slideIn 0.3s ease; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; transform: translateX(400px); transition: transform 0.3s ease; z-index: 2000; display: flex; align-items: center; gap: 8px; }
        .toast.show { transform: translateX(0); }
        
        .login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); max-width: 400px; width: 90%; text-align: center; }
        
        .hidden { display: none !important; }
        
        .nav-item.active { background: #2563eb; color: white; }
        
        .setup-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 16px; margin-top: 20px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center font-bold text-2xl text-white mx-auto mb-4">UX</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Bienvenido a UXMAL Pro</h2>
            <p class="text-slate-500 mb-6">Ingresa tus credenciales</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="tu@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:border-blue-500" placeholder="••••••••">
                </div>
            </div>
            
            <button onclick="login()" id="loginBtn" class="w-full mt-6 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-all">
                Ingresar al Sistema
            </button>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm hidden"></div>
            
            <!-- Setup Inicial - Solo aparece si no hay usuarios -->
            <div id="setupSection" class="setup-box hidden">
                <h3 class="font-bold text-lg mb-2"><i class="fas fa-cog mr-2"></i>Configuración Inicial</h3>
                <p class="text-sm mb-4 opacity-90">No se detectaron usuarios administradores. Crea el primer usuario para comenzar.</p>
                <button onclick="showSetupModal()" class="w-full bg-white text-purple-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-100 transition-all">
                    <i class="fas fa-user-plus mr-2"></i>Crear Usuario Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Setup Inicial -->
    <div id="setupModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-2xl text-white">
                <h3 class="text-lg font-bold"><i class="fas fa-user-shield mr-2"></i>Crear Administrador Inicial</h3>
                <button onclick="closeModal('setup')" class="text-white hover:text-gray-200"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="setupForm" onsubmit="createInitialAdmin(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo</label>
                    <input type="text" id="setup-name" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Administrador UXMAL">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="setup-email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="admin@uxmalstream.mx">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña</label>
                    <input type="password" id="setup-password" required minlength="6" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Mínimo 6 caracteres">
                </div>
                <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700">
                    <i class="fas fa-info-circle mr-1"></i>
                    Este será el usuario administrador principal con acceso total al sistema.
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('setup')" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">Cancelar</button>
                    <button type="submit" id="btn-setup" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 font-medium">
                        <i class="fas fa-check mr-1"></i>Crear y Continuar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="flex h-screen overflow-hidden hidden">
        <aside class="w-64 bg-slate-900 text-white flex flex-col">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center font-bold text-lg">UX</div>
                    <div>
                        <h1 class="font-bold text-lg">UXMAL Pro</h1>
                        <p class="text-xs text-slate-400" id="userDisplay">Usuario</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1">
                <a href="#" onclick="showTab('dashboard')" class="nav-item active flex items-center gap-3 px-4 py-3 rounded-lg text-white font-medium transition-colors">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </a>
                <a href="#" onclick="showTab('tickets')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-clipboard-list w-5"></i> Incidencias
                </a>
                <a href="#" onclick="showTab('clientes')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors">
                    <i class="fas fa-database w-5"></i> Clientes
                </a>
                <a href="#" id="nav-usuarios" onclick="showTab('usuarios')" class="nav-item flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 transition-colors hidden">
                    <i class="fas fa-users-cog w-5"></i> Usuarios
                </a>
            </nav>
            
            <div class="p-4 border-t border-slate-700">
                <button onclick="logout()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2 transition-all text-sm">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </aside>
        
        <main class="flex-1 overflow-y-auto p-8">
            <!-- Dashboard -->
            <div id="tab-dashboard" class="tab-content">
                <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm">
                        <p class="text-xs font-medium text-slate-500 uppercase">Total Tickets</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="dash-total">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm border-l-4 border-red-500">
                        <p class="text-xs font-medium text-slate-500 uppercase">En Atención</p>
                        <p class="text-3xl font-bold text-red-600 mt-2" id="dash-atencion">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm border-l-4 border-emerald-500">
                        <p class="text-xs font-medium text-slate-500 uppercase">Solucionados</p>
                        <p class="text-3xl font-bold text-emerald-600 mt-2" id="dash-solucionados">0</p>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-slate-200 shadow-sm border-l-4 border-amber-500">
                        <p class="text-xs font-medium text-slate-500 uppercase">Pendientes</p>
                        <p class="text-3xl font-bold text-amber-600 mt-2" id="dash-pendientes">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Tickets -->
            <div id="tab-tickets" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Incidencias</h2>
                    <button onclick="openModal('newTicket')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-plus"></i> Nueva Incidencia
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Folio</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Cliente</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Falla</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Clientes -->
            <div id="tab-clientes" class="tab-content hidden">
                <h2 class="text-2xl font-bold mb-6">Clientes</h2>
                <div id="clientes-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>
            
            <!-- Usuarios (Admin Only) -->
            <div id="tab-usuarios" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Gestión de Usuarios</h2>
                    <button onclick="openModal('newUser')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                        <i class="fas fa-user-plus"></i> Nuevo Usuario
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Usuario</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Email</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Rol</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nueva Incidencia -->
    <div id="newTicketModal" class="modal">
        <div class="modal-content max-w-2xl">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-slate-800">Nueva Incidencia</h3>
                <button onclick="closeModal('newTicket')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="ticketForm" onsubmit="saveTicket(event)" class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Folio</label>
                        <input type="text" id="input-folio" readonly class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Fecha</label>
                        <input type="date" id="input-fecha" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Cliente</label>
                    <select id="select-cliente" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="">Seleccionar cliente...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Falla</label>
                    <select id="select-falla" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="">Seleccionar falla...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Estatus</label>
                    <select id="select-estatus" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        <option value="EN ATENCIÓN TÉCNICA">En Atención Técnica</option>
                        <option value="SOLUCIONADO POR SOPORTE">Solucionado</option>
                        <option value="PENDIENTE POR CLIENTE">Pendiente</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Comentarios</label>
                    <textarea id="input-comentarios" rows="3" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('newTicket')" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Nuevo Usuario -->
    <div id="newUserModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-slate-50 rounded-t-2xl">
                <h3 class="text-lg font-bold text-slate-800">Crear Nuevo Usuario</h3>
                <button onclick="closeModal('newUser')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="userForm" onsubmit="saveUser(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo</label>
                    <input type="text" id="user-fullname" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Nombre del usuario">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <input type="email" id="user-email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="usuario@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Contraseña</label>
                    <input type="password" id="user-password" required minlength="6" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="Mínimo 6 caracteres">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Rol</label>
                        <select id="user-role" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            <option value="colaborador">Colaborador</option>
                            <option value="cliente">Cliente</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div id="cliente-asignado-container" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Cliente Asignado</label>
                        <select id="user-cliente" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            <option value="">Seleccionar cliente...</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Teléfono (opcional)</label>
                    <input type="tel" id="user-telefono" class="w-full px-4 py-2 border border-slate-300 rounded-lg" placeholder="555-123-4567">
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="closeModal('newUser')" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">Cancelar</button>
                    <button type="submit" id="btn-save-user" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">Crear Usuario</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // ==========================================
        // CONFIGURACIÓN DE SUPABASE - SOLO UNA VEZ
        // ==========================================
        const SUPABASE_URL = 'https://evlenjpwgyxmdduvlyot.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2bGVuanB3Z3l4bWRkdXZseW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExODMyMTIsImV4cCI6MjA4Njc1OTIxMn0.hZBQonAB69fS4iOW_LFb-hpZrwR-BOFoOfOE-2rVqrQ';
        
        // Inicializar Supabase solo una vez
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // VARIABLES GLOBALES
        let currentUser = null;
        let currentProfile = null;
        let tickets = [];
        let clientes = [];
        let catalogos = [];
        let allUsers = [];

        // ==========================================
        // INICIALIZACIÓN
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar si hay sesión activa
            const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
            
            if (sessionError) {
                console.error('Error al obtener sesión:', sessionError);
            }
            
            if (session) {
                await loadUserProfile(session.user);
            } else {
                // Verificar si existen usuarios en el sistema
                await checkInitialSetup();
            }
            
            // Escuchar cambios en rol para mostrar/ocultar selector de cliente
            document.getElementById('user-role')?.addEventListener('change', function() {
                const container = document.getElementById('cliente-asignado-container');
                if (this.value === 'cliente') {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });
        });

        // ==========================================
        // SETUP INICIAL - Crear primer usuario admin
        // ==========================================
        async function checkInitialSetup() {
            try {
                // Intentar obtener lista de usuarios para ver si existe alguno
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('id')
                    .limit(1);
                
                // Si no hay perfiles, mostrar opción de setup inicial
                if (!error && (!profiles || profiles.length === 0)) {
                    document.getElementById('setupSection').classList.remove('hidden');
                    showToast('Sistema sin configurar. Crea el primer usuario administrador.', 'info');
                }
            } catch (e) {
                console.log('No se pudo verificar usuarios existentes');
            }
        }

        function showSetupModal() {
            document.getElementById('setupModal').classList.add('active');
        }

        async function createInitialAdmin(event) {
            event.preventDefault();
            
            const btn = document.getElementById('btn-setup');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creando...';
            btn.disabled = true;
            
            const name = document.getElementById('setup-name').value;
            const email = document.getElementById('setup-email').value;
            const password = document.getElementById('setup-password').value;
            
            try {
                // 1. Crear usuario en auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            nombre: name,
                            rol: 'admin'
                        }
                    }
                });
                
                if (authError) throw authError;
                
                // 2. Crear perfil manualmente (por si el trigger falla)
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert([{
                        id: authData.user.id,
                        full_name: name,
                        email: email,
                        role: 'admin',
                        is_active: true,
                        created_at: new Date().toISOString()
                    }]);
                
                if (profileError) {
                    console.warn('Error creando perfil (puede que el trigger ya lo haya creado):', profileError);
                }
                
                showToast('¡Administrador creado exitosamente! Iniciando sesión...', 'success');
                
                // 3. Iniciar sesión automáticamente
                setTimeout(async () => {
                    const { data: loginData, error: loginError } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (loginError) {
                        showToast('Usuario creado. Por favor inicia sesión manualmente.', 'success');
                        closeModal('setup');
                        document.getElementById('setupSection').classList.add('hidden');
                    } else {
                        await loadUserProfile(loginData.user);
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Error:', error);
                showToast('Error: ' + error.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==========================================
        // AUTENTICACIÓN
        // ==========================================
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Ingresa email y contraseña');
                return;
            }
            
            const btn = document.getElementById('loginBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email: email, 
                    password: password 
                });
                
                if (error) throw error;
                await loadUserProfile(data.user);
            } catch (error) {
                showError('Email o contraseña incorrectos');
                btn.innerHTML = 'Ingresar al Sistema';
                btn.disabled = false;
            }
        }

        async function loadUserProfile(user) {
            try {
                // Esperar un momento para que el trigger cree el perfil si es nuevo
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    // Si no existe el perfil, crearlo manualmente
                    if (error.code === 'PGRST116') {
                        const { data: newProfile, error: createError } = await supabaseClient
                            .from('profiles')
                            .insert([{
                                id: user.id,
                                full_name: user.user_metadata?.nombre || user.email,
                                email: user.email,
                                role: user.user_metadata?.rol || 'colaborador',
                                is_active: true,
                                created_at: new Date().toISOString()
                            }])
                            .select()
                            .single();
                        
                        if (createError) throw createError;
                        currentProfile = newProfile;
                    } else {
                        throw error;
                    }
                } else {
                    currentProfile = profile;
                }
                
                currentUser = user;
                document.getElementById('userDisplay').textContent = currentProfile.full_name;
                
                // Mostrar menú de usuarios solo si es admin
                if (currentProfile.role === 'admin') {
                    document.getElementById('nav-usuarios').classList.remove('hidden');
                }
                
                showMainApp();
                await loadData();
                
            } catch (error) {
                console.error('Error cargando perfil:', error);
                showError('Error al cargar perfil de usuario');
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            currentProfile = null;
            location.reload(); // Recargar para limpiar estado
        }

        // ==========================================
        // CARGA DE DATOS
        // ==========================================
        async function loadData() {
            try {
                // Cargar clientes
                const { data: clientesData, error: clientesError } = await supabaseClient
                    .from('clientes')
                    .select('*')
                    .eq('activo', true);
                
                if (clientesError) throw clientesError;
                clientes = clientesData || [];
                
                // Cargar catálogos (fallas)
                const { data: catalogosData, error: catalogosError } = await supabaseClient
                    .from('catalogos')
                    .select('*')
                    .eq('tipo', 'falla');
                
                if (catalogosError) throw catalogosError;
                catalogos = catalogosData || [];
                
                // Cargar tickets según rol
                let query = supabaseClient.from('tickets').select('*');
                
                if (currentProfile.role === 'colaborador') {
                    query = query.or(`colaborador.eq.${currentProfile.full_name},asignado_a.eq.${currentProfile.full_name}`);
                } else if (currentProfile.role === 'cliente') {
                    const cliente = clientes.find(c => c.id === currentProfile.cliente_asignado);
                    if (cliente) {
                        query = query.eq('cliente', cliente.nombre);
                    }
                }
                
                const { data: ticketsData, error: ticketsError } = await query
                    .order('created_at', { ascending: false });
                
                if (ticketsError) throw ticketsError;
                tickets = ticketsData || [];
                
                // Si es admin, cargar usuarios
                if (currentProfile.role === 'admin') {
                    await loadUsers();
                }
                
                renderDashboard();
                renderTickets();
                renderClientes();
                populateSelects();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showToast('Error al cargar datos: ' + error.message, 'error');
            }
        }

        async function loadUsers() {
            try {
                // Obtener perfiles directamente de la tabla
                const { data: profiles, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Enriquecer con datos de auth si es posible
                allUsers = profiles.map(p => ({
                    id: p.id,
                    email: p.email,
                    profile: p,
                    user_metadata: { nombre: p.full_name, rol: p.role }
                }));
                
                renderUsers();
            } catch (error) {
                console.error('Error cargando usuarios:', error);
            }
        }

        // ==========================================
        // RENDERIZADO
        // ==========================================
        function renderDashboard() {
            document.getElementById('dash-total').textContent = tickets.length;
            document.getElementById('dash-atencion').textContent = tickets.filter(t => t.estatus === 'EN ATENCIÓN TÉCNICA').length;
            document.getElementById('dash-solucionados').textContent = tickets.filter(t => t.estatus === 'SOLUCIONADO POR SOPORTE').length;
            document.getElementById('dash-pendientes').textContent = tickets.filter(t => t.estatus === 'PENDIENTE POR CLIENTE').length;
        }

        function renderTickets() {
            const tbody = document.getElementById('tickets-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = tickets.map(t => `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3 font-bold text-slate-700">${t.folio}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${t.cliente}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${t.falla}</td>
                    <td class="px-4 py-3"><span class="status-badge ${getStatusClass(t.estatus)}">${t.estatus}</span></td>
                    <td class="px-4 py-3 text-sm text-slate-500">${t.fecha}</td>
                </tr>
            `).join('');
        }

        function renderClientes() {
            const container = document.getElementById('clientes-grid');
            if (!container) return;
            
            container.innerHTML = clientes.map(c => `
                <div class="bg-white rounded-xl border border-slate-200 p-4">
                    <h4 class="font-bold text-slate-800">${c.nombre}</h4>
                    <p class="text-sm text-slate-500 mt-1">Tickets: ${tickets.filter(t => t.cliente === c.nombre).length}</p>
                </div>
            `).join('');
        }

        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            if (!tbody) return;
            
            tbody.innerHTML = allUsers.map(u => {
                const role = u.profile?.role || 'colaborador';
                return `
                <tr class="hover:bg-slate-50">
                    <td class="px-4 py-3">
                        <div class="font-medium text-slate-800">${u.profile?.full_name || 'Sin nombre'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-slate-600">${u.email}</td>
                    <td class="px-4 py-3"><span class="role-badge role-${role}">${role}</span></td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs ${u.profile?.is_active ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}">
                            ${u.profile?.is_active ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        ${u.id !== currentUser?.id ? `
                        <button onclick="deleteUser('${u.id}')" class="text-red-600 hover:text-red-800 transition-colors" title="Eliminar usuario">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        ` : '<span class="text-slate-400 text-xs">Tú</span>'}
                    </td>
                </tr>
            `}).join('');
        }

        function populateSelects() {
            const clienteSelect = document.getElementById('select-cliente');
            if (clienteSelect) {
                clienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                    clientes.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join('');
            }
            
            const fallaSelect = document.getElementById('select-falla');
            if (fallaSelect) {
                fallaSelect.innerHTML = '<option value="">Seleccionar falla...</option>' +
                    catalogos.map(f => `<option value="${f.valor}">${f.valor}</option>`).join('');
            }
            
            const userClienteSelect = document.getElementById('user-cliente');
            if (userClienteSelect) {
                userClienteSelect.innerHTML = '<option value="">Seleccionar cliente...</option>' +
                    clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
            }
        }

        // ==========================================
        // GUARDAR TICKET
        // ==========================================
        async function saveTicket(event) {
            event.preventDefault();
            
            const ticket = {
                folio: document.getElementById('input-folio').value,
                fecha: document.getElementById('input-fecha').value,
                hora: new Date().toTimeString().slice(0, 5),
                colaborador: currentProfile.full_name,
                asignado_a: currentProfile.full_name,
                cliente: document.getElementById('select-cliente').value,
                falla: document.getElementById('select-falla').value,
                estatus: document.getElementById('select-estatus').value,
                comentarios: document.getElementById('input-comentarios').value,
                metodo: 'Web',
                responsable: 'Uxmal'
            };
            
            try {
                const { error } = await supabaseClient.from('tickets').insert([ticket]);
                if (error) throw error;
                
                showToast('Incidencia guardada exitosamente', 'success');
                closeModal('newTicket');
                document.getElementById('ticketForm').reset();
                await loadData();
                
            } catch (error) {
                console.error('Error guardando ticket:', error);
                showToast('Error al guardar: ' + error.message, 'error');
            }
        }

        // ==========================================
        // GUARDAR USUARIO (ADMIN)
        // ==========================================
        async function saveUser(event) {
            event.preventDefault();
            
            const btn = document.getElementById('btn-save-user');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
            btn.disabled = true;
            
            const userData = {
                full_name: document.getElementById('user-fullname').value,
                email: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                cliente_asignado: document.getElementById('user-cliente').value || null,
                telefono: document.getElementById('user-telefono').value || null
            };
            
            try {
                // Crear usuario en auth
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: userData.email,
                    password: userData.password,
                    options: {
                        data: {
                            nombre: userData.full_name,
                            rol: userData.role
                        }
                    }
                });
                
                if (authError) throw authError;
                
                // Actualizar perfil con datos adicionales
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({
                        cliente_asignado: userData.cliente_asignado,
                        telefono: userData.telefono
                    })
                    .eq('id', authData.user.id);
                
                if (updateError) console.warn('Error actualizando perfil:', updateError);
                
                showToast('Usuario creado exitosamente', 'success');
                closeModal('newUser');
                document.getElementById('userForm').reset();
                await loadUsers();
                
            } catch (error) {
                console.error('Error creando usuario:', error);
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==========================================
        // ELIMINAR USUARIO
        // ==========================================
        async function deleteUser(userId) {
            if (!confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')) {
                return;
            }
            
            try {
                // Eliminar perfil primero
                const { error: profileError } = await supabaseClient
                    .from('profiles')
                    .delete()
                    .eq('id', userId);
                
                if (profileError) throw profileError;
                
                // Nota: El usuario en auth.users permanece, pero ya no podrá acceder
                // ya que no tiene perfil. Para eliminar completamente se necesitaría
                // una Edge Function con SERVICE_ROLE_KEY.
                
                showToast('Usuario eliminado del sistema', 'success');
                await loadUsers();
                
            } catch (error) {
                console.error('Error eliminando usuario:', error);
                showToast('Error al eliminar: ' + error.message, 'error');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Configurar valores por defecto
            const fechaInput = document.getElementById('input-fecha');
            if (fechaInput) fechaInput.valueAsDate = new Date();
            
            const folioInput = document.getElementById('input-folio');
            if (folioInput) folioInput.value = 'UX' + Date.now().toString().slice(-5);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            const tab = document.getElementById('tab-' + tabName);
            if (tab) tab.classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active', 'bg-blue-600', 'text-white');
                n.classList.add('text-slate-300');
            });
            
            const activeNav = event.target.closest('.nav-item');
            if (activeNav) {
                activeNav.classList.add('active', 'bg-blue-600', 'text-white');
                activeNav.classList.remove('text-slate-300');
            }
        }

        function openModal(modal) {
            const modalEl = document.getElementById(modal + 'Modal');
            if (modalEl) modalEl.classList.add('active');
        }

        function closeModal(modal) {
            const modalEl = document.getElementById(modal + 'Modal');
            if (modalEl) modalEl.classList.remove('active');
        }

        function getStatusClass(status) {
            const classes = {
                'SOLUCIONADO POR SOPORTE': 'status-solucionado',
                'EN ATENCIÓN TÉCNICA': 'status-atencion',
                'PENDIENTE POR CLIENTE': 'status-pendiente',
                'EN SEGUIMIENTO': 'status-seguimiento',
                'CERRADO': 'status-cerrado'
            };
            return classes[status] || 'status-pendiente';
        }

        function showError(msg) {
            const el = document.getElementById('loginError');
            if (el) {
                el.textContent = msg;
                el.classList.remove('hidden');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                info: 'info-circle'
            };
            
            toast.className = `toast ${colors[type] || colors.info}`;
            toast.innerHTML = `<i class="fas fa-${icons[type] || icons.info} mr-2"></i>${message}`;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==========================================
        // EXPONER FUNCIONES GLOBALES
        // ==========================================
        window.login = login;
        window.logout = logout;
        window.showTab = showTab;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveTicket = saveTicket;
        window.saveUser = saveUser;
        window.deleteUser = deleteUser;
        window.showSetupModal = showSetupModal;
        window.createInitialAdmin = createInitialAdmin;
    </script>
</body>
</html>